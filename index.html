<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Blast Solver v10.3</title>
    <style>
        /* --- ğŸ¨ ç¾è¡“è¨­å®š --- */
        :root {
            --bg-color: #2C3E50;
            --board-bg: #34495E;
            --cell-empty: rgba(236, 240, 241, 0.1); 
            --img-filled: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjN0Y4QzhEIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1Ii8+PHBhdGggZD0iTTMwIDQwIEw0MCAzMCBMNTAgNDAgTDYwIDMwIEw3MCA0MCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjMiIGZpbGw9Im5vbmUiLz48Y2lyY2xlIGN4PSIzNSIgY3k9IjYwIiByPSI1IiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iNjUiIGN5PSI2MCIgcj0iNSIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==');
            --img-new: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzQ5OERCIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1Ii8+PHBhdGggZD0iTTIwIDMwIEwzMCAxNSBMNDAgMzAgTDYwIDMwIEw3MCAxNSBMODAgMzAiIGZpbGw9IiMyOTgwQjkiLz48Y2lyY2xlIGN4PSIzNSIgY3k9IjU1IiByPSI1IiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iNjUiIGN5PSI1NSIgcj0iNSIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik00NSA3MCBRNTAgODAgNTUgNzAiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzIiBmaWxsPSJub25lIi8+PC9zdmc+');
            --img-preview: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMkVDQzcxIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1IiBvcGFjaXR5PSIwLjgiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjY1IiByPSIxNSIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iNDUiIHI9IjgiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSI4IiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iNzAiIGN5PSI0NSIgcj0iOCIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==');
            --img-clearing: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjRjFDNDBGIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1Ii8+PHBhdGggZD0iTTUwIDEwIEw2MCA0MCBMOTAgNTAgTDYwIDYwIEw1MCA5MCBMNDAgNjAgTDEwIDUwIEw0MCA0MCBaIiBmaWxsPSIjZmZmIi8+PC9zdmc+');
            --text-color: white;
            --modal-bg: rgba(44, 62, 80, 0.98);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            position: relative;
            user-select: none; -webkit-user-select: none;
            padding-bottom: 50px; 
            -webkit-touch-callout: none;
        }

        body::before {
            content: "";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: auto; aspect-ratio: 3/2;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA5MDAgNjAwIj48cmVjdCB3aWR0aD0iOTAwIiBoZWlnaHQ9IjYwMCIgZmlsbD0iI0ZFMDAwMCIvPjxyZWN0IHdpZHRoPSI0NTAiIGhlaWdodD0iMzAwIiBmaWxsPSIjMDAwMDk1Ii8+PHBhdGggZmlsbD0iI0ZGRkZGRiIgZD0ibTIyNSA2NiA5IDY1IDYxLTIzLTIzIDYxIDY1IDktNjUgOSAyMyA2MS02MS0yMy05IDY1LTktNjUtNjEgMjMgMjMtNjEtNjUtOSA2NS05LTIzLTYxIDYxIDIzem0wIDM3IDUuNiA0MC42IDM4LjEtMTQuMy0xNC4zIDM4LjEgNDAuNiA1LjYtNDAuNiA1LjYgMTQuMyAzOC4xLTM4LjEtMTQuMy01LjYgNDAuNi01LjYtNDAuNi0zOC4xIDE0LjMgMTQuMy0zOC4xLTQwLjYtNS42IDQwLjYtNS42LTE0LjMtMzguMSAzOC4xIDE0LjN6Ii8+PC9zdmc+');
            background-repeat: no-repeat; background-position: center; background-size: contain;
            opacity: 0.05; pointer-events: none; z-index: 0;
        }

        .header {
            width: 100%; max-width: 500px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; z-index: 2; height: 40px; position: relative;
        }

        h1 { 
            position: absolute; left: 50%; transform: translateX(-50%);
            margin: 0; font-size: 1.2rem; white-space: nowrap; 
        }

        .header-btn {
            background: transparent; border: none;
            color: white; font-size: 1.6rem;
            cursor: pointer; padding: 5px;
            display: flex; align-items: center; justify-content: center;
            line-height: 1;
        }
        
        .lang-select {
            position: absolute; top: 45px; right: 40px;
            background: #34495E; border-radius: 8px;
            padding: 5px; display: none; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 200;
            min-width: 120px;
        }
        .lang-select.show { display: flex; }
        .lang-opt {
            padding: 10px; color: white; background: none; border: none;
            text-align: left; font-size: 1rem; cursor: pointer;
        }
        .lang-opt:hover { background: #2C3E50; }

        .container {
            display: flex; flex-direction: column; width: 100%; max-width: 500px;
            align-items: center; gap: 15px; z-index: 1;
        }

        .board-wrapper {
            width: 95vw; max-width: 500px;
            background-color: var(--board-bg);
            border-radius: 8px; padding: 5px;
            aspect-ratio: 1 / 1;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            touch-action: none; 
        }

        .board-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; display: none; 
        }
        .board-wrapper.locked .board-overlay { display: block; }

        .board-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr); 
            grid-template-rows: repeat(8, 1fr);
            gap: 2px; width: 100%; height: 100%;
            /* ç¹¼æ‰¿ v4 çš„è¨­å®š */
            touch-action: none; 
        }

        .cell {
            background-color: var(--cell-empty);
            border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1rem; color: white;
            user-select: none;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            /* ç¹¼æ‰¿ v4 çš„è¨­å®šï¼Œç¢ºä¿æ ¼å­æœ¬èº«èƒ½æ¥æ”¶è§¸æ§ */
            touch-action: none;
        }

        .cell.filled { background-image: var(--img-filled); }
        .cell.new { background-image: var(--img-new); }
        .cell.clearing { background-image: var(--img-clearing); animation: pulse 0.5s infinite alternate; }
        .cell.preview { background-image: var(--img-preview) !important; color: #000; opacity: 1 !important; } 
        .cell.preview.clearing { box-shadow: inset 0 0 0 3px #F1C40F, 0 0 15px #F1C40F; z-index: 5; }

        @keyframes pulse { from { opacity: 1; } to { opacity: 0.6; } }

        .controls {
            width: 95vw; max-width: 500px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }

        button {
            border: none; padding: 12px; border-radius: 6px;
            font-size: 1rem; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background-color: #555 !important; color: #aaa !important; cursor: not-allowed; box-shadow: none; }

        .btn-undo { background-color: #95A5A6; color: white; }
        .btn-clear { background-color: #E74C3C; color: white; }
        .btn-solve { background-color: #27AE60; color: white; width: 100%; margin: 10px 0; font-size: 1.2rem; padding: 15px; }
        .btn-next { background-color: #F39C12; color: white; width: 100%; padding: 15px;}
        
        .right-panel {
            width: 95vw; max-width: 500px;
            display: flex; flex-direction: column;
        }

        .panel-label { margin-bottom: 5px; font-size: 0.9rem; color: #BDC3C7; text-align: center;}

        .hand-area {
            background-color: var(--board-bg);
            height: 90px; border-radius: 8px;
            padding: 5px 10px; display: flex; gap: 10px;
            align-items: center; justify-content: center;
            margin-bottom: 10px;
        }

        .mini-grid-wrapper { display: flex; justify-content: center; align-items: center; position: relative; }
        .mini-grid { display: grid; gap: 1px; }
        .mini-cell { width: 100%; height: 100%; background-image: var(--img-new); background-size: cover; border-radius: 1px; }

        .hand-piece {
            position: relative; background: rgba(0,0,0,0.2);
            padding: 4px; border-radius: 4px;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .hand-piece .remove-btn {
            position: absolute; top: -8px; right: -8px;
            background: #E74C3C; color: white; border-radius: 50%;
            width: 22px; height: 22px; font-size: 14px;
            line-height: 22px; text-align: center; font-weight: bold;
            border: 2px solid var(--board-bg); cursor: pointer; z-index: 5;
        }

        .status-msg {
            text-align: center; margin: 5px 0; min-height: 24px;
            color: #F1C40F; font-weight: bold;
        }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-bg); z-index: 100;
            display: flex; flex-direction: column; align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px); transition: opacity 0.3s;
            visibility: hidden; opacity: 0;
        }
        .modal.show { visibility: visible; opacity: 1; }

        .modal-header {
            width: 100%; max-width: 600px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; flex-shrink: 0;
        }
        .modal-controls { display: flex; gap: 15px; align-items: center; }
        
        .close-btn { background: transparent; font-size: 2rem; color: white; padding: 0; border: none; cursor: pointer; line-height: 1; }
        .clear-sel-btn { background: transparent; font-size: 1.5rem; color: #E74C3C; padding: 0; border: none; cursor: pointer; line-height: 1; }
        
        .confirm-btn {
            background-color: #2ECC71; color: white;
            border: none; padding: 5px 12px; border-radius: 4px;
            font-size: 0.9rem; cursor: pointer; display: none; 
            font-weight: bold;
        }

        .category-title {
            width: 100%; max-width: 600px;
            color: #BDC3C7; font-size: 0.9rem; margin: 15px 0 5px 0; border-bottom: 1px solid #555;
        }

        .library-content {
            flex: 1; width: 100%; max-width: 600px;
            overflow-y: auto; padding-bottom: 50px;
            -webkit-overflow-scrolling: touch; 
        }

        .lib-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 15px;
        }

        .lib-piece {
            aspect-ratio: 1;
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
            transition: transform 0.1s;
        }
        .lib-piece:active { transform: scale(0.95); }
        
        .lib-piece .count-badge {
            position: absolute; top: -5px; right: -5px;
            background: #2ECC71; color: white;
            border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; line-height: 20px; text-align: center;
            display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 5;
        }
        .lib-piece.selected { border: 2px solid #2ECC71; background-color: rgba(46, 204, 113, 0.2); }
        .lib-piece.selected .count-badge { display: block; }
        .lib-piece canvas { max-width: 85%; max-height: 85%; }

        /* æ•¸é‡é¸æ“‡å™¨ Popup */
        .qty-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; display: none; 
        }
        .qty-popup {
            position: absolute; 
            background: #34495E;
            border: 2px solid #2ECC71;
            border-radius: 12px;
            padding: 8px;
            display: none;
            gap: 10px;
            z-index: 201;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
        }
        .qty-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #2ECC71;
            color: white;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }
        .qty-btn:active { transform: scale(0.9); }

        .help-content {
            flex: 1; width: 100%; max-width: 600px;
            overflow-y: auto; color: #ddd; font-size: 0.95rem; line-height: 1.6;
        }
        .help-content h3 { color: #3498DB; margin-top: 0; }
        .help-content ul { padding-left: 20px; }
        .help-content li { margin-bottom: 5px; }
        .help-footer {
            margin-top: 20px; padding-top: 15px; border-top: 1px solid #555; text-align: center;
        }
        .help-footer a { color: #2ECC71; text-decoration: none; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <button class="header-btn" onclick="openLibrary()" style="font-size: 1.8rem;">â–¦</button>
        <h1>Block Blast Solver</h1>
        <div style="display:flex; gap:15px;">
            <button class="header-btn" onclick="toggleLangMenu()">ğŸŒ</button>
            <button class="header-btn" onclick="openHelp()">â”</button>
        </div>
    </div>

    <div id="langMenu" class="lang-select">
        <button class="lang-opt" onclick="setLang('zh')">ç¹é«”ä¸­æ–‡</button>
        <button class="lang-opt" onclick="setLang('en')">English</button>
        <button class="lang-opt" onclick="setLang('jp')">æ—¥æœ¬èª</button>
        <button class="lang-opt" onclick="setLang('kr')">í•œêµ­ì–´</button>
    </div>

    <div class="container">
        <div id="boardWrapper" class="board-wrapper">
            <div class="board-overlay"></div>
            <div id="board" class="board-container"></div>
        </div>
        
        <div class="right-panel">
            <div class="panel-label" style="margin-top: 10px;" data-key="handLabel">æœ¬è¼ªæ–¹å¡Š</div>
            <div id="hand" class="hand-area"><span style="color: #777;" data-key="empty">(ç©º)</span></div>
        
            <div class="controls" style="width: 100%; margin-bottom:10px;">
                <button id="btnUndo" class="btn-undo" onclick="undoBoard()" data-key="undo" disabled>â†º ä¸Šä¸€æ­¥</button>
                <button id="btnClear" class="btn-clear" onclick="clearBoard()" data-key="clear">ğŸ—‘ æ¸…ç©º</button>
            </div>

            <div id="status" class="status-msg"></div>
            <button id="btnSolve" class="btn-solve" onclick="runSolver()" data-key="solve">âœ¨ è¨ˆç®—æœ€ä½³è§£ âœ¨</button>
            <button id="btnNext" class="btn-next" onclick="applyNextStep()" disabled data-key="next">åŸ·è¡Œé€™ä¸€æ­¥ â–¶</button>
        </div>
    </div>

    <div id="libModal" class="modal">
        <div class="modal-header">
            <h2 style="margin:0">
                <span data-key="selectTitle">é¸æ“‡æ–¹å¡Š</span> 
                <span style="font-size:0.9em; margin-left:5px;">(<span id="selCount">0</span>/3)</span>
            </h2>
            <div class="modal-controls">
                <button id="btnConfirmSelection" class="confirm-btn" onclick="closeModal('libModal')" data-key="confirm">âœ” ç¢ºå®š</button>
                <button class="clear-sel-btn" onclick="clearSelection()">ğŸ—‘</button>
                <button class="close-btn" onclick="closeModal('libModal')">Ã—</button>
            </div>
        </div>
        <div style="font-size: 0.8rem; color: #BDC3C7; margin-bottom: 10px;" data-key="selectHint">é»æ“Š: +1 / -1 | é•·æŒ‰: æ•¸é‡</div>
        <div id="libContent" class="library-content"></div>
    </div>

    <div id="qtyOverlay" class="qty-overlay" onclick="hideQtyPopup()"></div> 
    <div id="qtyPopup" class="qty-popup">
        <button class="qty-btn" onclick="setQty(1)">1</button>
        <button class="qty-btn" onclick="setQty(2)">2</button>
        <button class="qty-btn" onclick="setQty(3)">3</button>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-header">
            <h2 style="margin:0" data-key="helpTitle">ä½¿ç”¨æŒ‡å—</h2>
            <button class="close-btn" onclick="closeModal('helpModal')">Ã—</button>
        </div>
        <div class="help-content">
            <div id="helpText"></div> 
            <div class="help-footer">
                <p data-key="contact">é‚„æœ‰å•é¡Œå—ï¼Ÿ</p>
                <a href="mailto:jerry1221yen@gmail.com">ğŸ“© jerry1221yen@gmail.com</a>
            </div>
        </div>
    </div>

<script>
// ==================== å¤šèªè¨€è¨­å®š ====================
const TRANSLATIONS = {
    zh: {
        title: "Block Blast Solver",
        undo: "â†º ä¸Šä¸€æ­¥",
        clear: "ğŸ—‘ æ¸…ç©º",
        solve: "âœ¨ è¨ˆç®—æœ€ä½³è§£ âœ¨",
        calculating: "è¨ˆç®—ä¸­...",
        next: "åŸ·è¡Œé€™ä¸€æ­¥ â–¶",
        finish: "å®Œæˆ (é»æ“Šç¢ºèª)",
        handLabel: "æœ¬è¼ªæ–¹å¡Š (é»æ“Šæ¸›å°‘)",
        empty: "(ç©º)",
        selectTitle: "é¸æ“‡æ–¹å¡Š",
        selectHint: "é»æ“Š: +1 / -1 | é•·æŒ‰: é¸æ•¸é‡",
        helpTitle: "ä½¿ç”¨æŒ‡å—",
        contact: "é‚„æœ‰å•é¡Œå—ï¼Ÿå¯„ä¿¡çµ¦æˆ‘ï¼š",
        categories: ["åŸºæœ¬ (é»ã€æ–œã€ç·š)", "æ–¹å¡Š & Tå‹ & Zå‹", "å° L (3æ ¼)", "ä¸­ L (4æ ¼)", "å¤§ L (5æ ¼)"],
        msg_select: "è«‹å…ˆé¸æ“‡æ–¹å¡Šï¼",
        msg_nosol: "âŒ ç„¡è§£ï¼(Game Over)",
        msg_done: "ğŸ‰ å®Œæˆï¼è«‹é‡æ–°é¸æ–¹å¡Š",
        msg_step: "æ­¥é©Ÿ",
        msg_clear: "æ¶ˆ",
        msg_row: "è¡Œ",
        confirm: "âœ” ç¢ºå®š",
        helpBody: `<h3>1. è¨­å®šç›¤é¢</h3><ul><li>æ‰‹æŒ‡åœ¨æ£‹ç›¤ä¸Šæ»‘å‹•å¯å¿«é€Ÿå¡—é»‘/æ“¦é™¤éšœç¤™ç‰©ã€‚</li></ul><h3>2. é¸æ“‡æ–¹å¡Š</h3><ul><li>é»æ“Šå·¦ä¸Šè§’ â–¦ æŒ‰éˆ•æ‰“é–‹æ–¹å¡Šåº«ã€‚</li><li><b>å–®é»ï¼š</b>è‹¥0å‰‡+1ï¼Œè‹¥æœ‰å‰‡-1ã€‚</li><li><b>é•·æŒ‰ï¼š</b>è¨­å®šæ•¸é‡ 1~3ã€‚</li></ul><h3>3. è¨ˆç®—</h3><ul><li>æŒ‰ä¸‹ã€Œè¨ˆç®—æœ€ä½³è§£ã€ã€‚</li><li>ç¶ è‰²ç‚ºå»ºè­°ä½ç½®ï¼Œé‡‘è‰²ä»£è¡¨æ¶ˆé™¤ã€‚</li><li>æŒ‰ã€ŒåŸ·è¡Œé€™ä¸€æ­¥ã€æ¨é€²ï¼ŒçµæŸæŒ‰ã€Œå®Œæˆã€ã€‚</li></ul>`
    },
    en: {
        title: "Block Blast Solver",
        undo: "â†º Undo",
        clear: "ğŸ—‘ Clear",
        solve: "âœ¨ Solve âœ¨",
        calculating: "Calculating...",
        next: "Next Step â–¶",
        finish: "Finish (Click to Fix)",
        handLabel: "Current Pieces (Tap to remove)",
        empty: "(Empty)",
        selectTitle: "Select Pieces",
        selectHint: "Tap: +1 / -1 | Hold: Quantity",
        helpTitle: "User Guide",
        contact: "Questions? Email me:",
        categories: ["Basic (Dot, Diag, Line)", "Square & T & Z", "Small L (3)", "Medium L (4)", "Large L (5)"],
        msg_select: "Please select pieces first!",
        msg_nosol: "âŒ No Solution!",
        msg_done: "ğŸ‰ Done! Pick new pieces.",
        msg_step: "Step",
        msg_clear: "Clear",
        msg_row: "lines",
        confirm: "âœ” OK",
        helpBody: `<h3>1. Setup Board</h3><ul><li>Swipe on the board to paint/erase blocks.</li></ul><h3>2. Select Pieces</h3><ul><li>Tap â–¦ to open library.</li><li><b>Tap:</b> Add 1 if empty, else Remove 1.</li><li><b>Hold:</b> Set Quantity 1-3.</li></ul><h3>3. Solve</h3><ul><li>Tap "Solve".</li><li>Green shows placement, Gold shows clearing.</li><li>Tap "Next Step" to proceed.</li></ul>`
    },
    jp: {
        title: "ãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ã‚ºãƒ«è§£æ³•ãƒ„ãƒ¼ãƒ«",
        undo: "â†º å…ƒã«æˆ»ã™",
        clear: "ğŸ—‘ ã‚¯ãƒªã‚¢",
        solve: "âœ¨ è¨ˆç®—ã™ã‚‹ âœ¨",
        calculating: "è¨ˆç®—ä¸­...",
        next: "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â–¶",
        finish: "å®Œäº† (ç¢ºå®šã™ã‚‹)",
        handLabel: "æ‰‹æŒã¡ (ã‚¿ãƒƒãƒ—ã§å‰Šé™¤)",
        empty: "(ç©º)",
        selectTitle: "ãƒ–ãƒ­ãƒƒã‚¯é¸æŠ",
        selectHint: "ã‚¿ãƒƒãƒ—: +1 / -1 | é•·æŠ¼ã—: æ•°é‡",
        helpTitle: "ä½¿ã„æ–¹",
        contact: "è³ªå•ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿãƒ¡ãƒ¼ãƒ«ï¼š",
        categories: ["åŸºæœ¬ (ç‚¹, æ–œã‚, ç·š)", "å››è§’ & Tå‹ & Zå‹", "å° L (3)", "ä¸­ L (4)", "å¤§ L (5)"],
        msg_select: "å…ˆã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸ã‚“ã§ãã ã•ã„ï¼",
        msg_nosol: "âŒ è§£ãªã—ï¼",
        msg_done: "ğŸ‰ å®Œäº†ï¼æ¬¡ã¸",
        msg_step: "æ‰‹é †",
        msg_clear: "æ¶ˆå»",
        msg_row: "è¡Œ",
        confirm: "âœ” ç¢ºå®š",
        helpBody: `<h3>1. ç›¤é¢è¨­å®š</h3><ul><li>ç›¤é¢ã‚’ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚’æç”»/æ¶ˆå»ã—ã¾ã™ã€‚</li></ul><h3>2. ãƒ–ãƒ­ãƒƒã‚¯é¸æŠ</h3><ul><li>â–¦ ãƒœã‚¿ãƒ³ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã™ã€‚</li><li><b>ã‚¿ãƒƒãƒ—ï¼š</b>0ãªã‚‰è¿½åŠ ã€ã‚ã‚Œã°1ã¤æ¸›ã‚‰ã™ã€‚</li><li><b>é•·æŠ¼ã—ï¼š</b>å€‹æ•°ã‚’é¸æŠã€‚</li></ul><h3>3. å®Ÿè¡Œ</h3><ul><li>ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’ã‚¿ãƒƒãƒ—ã€‚</li><li>ç·‘è‰²ã¯é…ç½®å ´æ‰€ã€é‡‘è‰²ã¯æ¶ˆãˆã‚‹è¡Œã§ã™ã€‚</li></ul>`
    },
    kr: {
        title: "ë¸”ë¡ ë¸”ë¼ìŠ¤íŠ¸ ì†”ë²„",
        undo: "â†º ì‹¤í–‰ ì·¨ì†Œ",
        clear: "ğŸ—‘ ì§€ìš°ê¸°",
        solve: "âœ¨ í•´ê²°í•˜ê¸° âœ¨",
        calculating: "ê³„ì‚° ì¤‘...",
        next: "ë‹¤ìŒ ë‹¨ê³„ â–¶",
        finish: "ì™„ë£Œ (í™•ì •)",
        handLabel: "í˜„ì¬ ë¸”ë¡ (íƒ­í•˜ì—¬ ì‚­ì œ)",
        empty: "(ë¹„ì–´ ìˆìŒ)",
        selectTitle: "ë¸”ë¡ ì„ íƒ",
        selectHint: "íƒ­: +1 / -1 | ê¸¸ê²Œ: ìˆ˜ëŸ‰",
        helpTitle: "ì‚¬ìš© ê°€ì´ë“œ",
        contact: "ë¬¸ì˜ ì‚¬í•­:",
        categories: ["ê¸°ë³¸ (ì , ëŒ€ê°ì„ , ì„ )", "ì‚¬ê°í˜• & Tì & Zì", "ì†Œí˜• L (3)", "ì¤‘í˜• L (4)", "ëŒ€í˜• L (5)"],
        msg_select: "ë¸”ë¡ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!",
        msg_nosol: "âŒ í•´ê²° ë¶ˆê°€!",
        msg_done: "ğŸ‰ ì™„ë£Œ!",
        msg_step: "ë‹¨ê³„",
        msg_clear: "ì œê±°",
        msg_row: "ì¤„",
        confirm: "âœ” í™•ì¸",
        helpBody: `<h3>1. ë³´ë“œ ì„¤ì •</h3><ul><li>ë³´ë“œë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë¸”ë¡ì„ ê·¸ë¦½ë‹ˆë‹¤.</li></ul><h3>2. ë¸”ë¡ ì„ íƒ</h3><ul><li>â–¦ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©”ë‰´ë¥¼ ì—½ë‹ˆë‹¤.</li><li><b>íƒ­:</b> ì—†ìœ¼ë©´ ì¶”ê°€, ìˆìœ¼ë©´ 1ê°œ ì‚­ì œ.</li><li><b>ê¸¸ê²Œ:</b> ìˆ˜ëŸ‰ ì„ íƒ.</li></ul><h3>3. ì‹¤í–‰</h3><ul><li>"í•´ê²°í•˜ê¸°"ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.</li><li>ë…¹ìƒ‰ì€ ë°°ì¹˜ ìœ„ì¹˜, ê¸ˆìƒ‰ì€ ì œê±°ë˜ëŠ” ì¤„ì…ë‹ˆë‹¤.</li></ul>`
    }
};

let currentLang = 'zh';

// ==================== è³‡æ–™èˆ‡è¨­å®š ====================
const SHAPES = {
    '1': [[1]],
    '2h': [[1,1]], '3h': [[1,1,1]], '4h': [[1,1,1,1]], '5h': [[1,1,1,1,1]],
    '2v': [[1],[1]], '3v': [[1],[1],[1]], '4v': [[1],[1],[1],[1]], '5v': [[1],[1],[1],[1],[1]],
    'd2': [[1,0],[0,1]], 'd2_r': [[0,1],[1,0]],
    'd3': [[1,0,0],[0,1,0],[0,0,1]], 'd3_r': [[0,0,1],[0,1,0],[1,0,0]],
    '2x2': [[1,1],[1,1]], '2x3': [[1,1,1],[1,1,1]], '3x2': [[1,1],[1,1],[1,1]], '3x3': [[1,1,1],[1,1,1],[1,1,1]],
    'T3': [[1,1,1],[0,1,0]], 'T3_r': [[0,1],[1,1],[0,1]], 'T3_m': [[0,1,0],[1,1,1]], 'T3_mr': [[1,0],[1,1],[1,0]],
    'z3': [[1,1,0],[0,1,1]], 'z3_r': [[0,1,1],[1,1,0]], 'z3v': [[0,1],[1,1],[1,0]], 'z3v_r': [[1,0],[1,1],[0,1]],
    'L2': [[1,0],[1,1]], 'L2_r': [[1,1],[1,0]], 'L2_m': [[1,1],[0,1]], 'L2_mr': [[0,1],[1,1]],
    'L3_2': [[1,0],[1,0],[1,1]], 'L3_2_inv': [[1,1],[1,0],[1,0]], 
    'L3_2_r': [[1,1,1],[1,0,0]], 'L3_2_r_inv': [[0,0,1],[1,1,1]],
    'J3_2': [[0,1],[0,1],[1,1]], 'J3_2_inv': [[1,1],[0,1],[0,1]],
    'J3_2_r': [[1,1,1],[0,0,1]], 'J3_2_r_inv': [[1,0,0],[1,1,1]],
    'L3': [[1,0,0],[1,0,0],[1,1,1]], 'L3_m': [[1,1,1],[0,0,1],[0,0,1]],
    'L3_r': [[1,1,1],[1,0,0],[1,0,0]],'L3_mr': [[0,0,1],[0,0,1],[1,1,1]],
    'J3': [[0,0,1],[0,0,1],[1,1,1]], 'J3_r': [[1,1,1],[0,0,1],[0,0,1]]
};

const CATEGORIES = [
    { key: 0, list: ['1', 'd2', 'd2_r', 'd3', 'd3_r', '2h', '3h', '4h', '5h', '2v', '3v', '4v', '5v'] },
    { key: 1, list: ['2x2', '2x3', '3x2', '3x3', 'T3', 'T3_r', 'T3_m', 'T3_mr', 'z3', 'z3_r', 'z3v', 'z3v_r'] },
    { key: 2, list: ['L2', 'L2_r', 'L2_m', 'L2_mr'] },
    { key: 3, list: ['L3_2', 'J3_2', 'L3_2_inv', 'J3_2_inv', 'L3_2_r', 'J3_2_r', 'L3_2_r_inv', 'J3_2_r_inv'] },
    { key: 4, list: ['L3', 'L3_r', 'L3_m', 'L3_mr', 'J3', 'J3_r'] }
];

function getColor(name) { return '#95A5A6'; }

// ==================== ç‹€æ…‹ ====================
let board = Array(8).fill().map(() => Array(8).fill(0));
let newlyPlacedCells = []; 
let clearingCells = [];    
let boardHistory = [];
let hand = [];
let solutionSteps = [];
let currentStepIdx = 0;
let isDragging = false;
let paintMode = 1; 
let isCalculating = false; 
let currentLongPressName = null;

const boardWrapper = document.getElementById('boardWrapper');
const boardEl = document.getElementById('board');
const handEl = document.getElementById('hand');
const libContentEl = document.getElementById('libContent');
const selCountEl = document.getElementById('selCount');
const statusEl = document.getElementById('status');
const btnNext = document.getElementById('btnNext');
const btnSolve = document.getElementById('btnSolve');
const btnUndo = document.getElementById('btnUndo');
const btnClear = document.getElementById('btnClear');
const langMenu = document.getElementById('langMenu');
const helpText = document.getElementById('helpText');
const btnConfirmSelection = document.getElementById('btnConfirmSelection');
const qtyPopup = document.getElementById('qtyPopup');
const qtyOverlay = document.getElementById('qtyOverlay');

function init() {
    renderBoard();
    renderLibraryMenu(); 
    updateLanguage(); 
    
    // é€™è£¡åªè² è²¬é‡ç½®æ‹–æ›³ç‹€æ…‹
    document.addEventListener('mouseup', () => { isDragging = false; });
    document.addEventListener('touchend', () => { isDragging = false; });
    
    // ç¦æ­¢ board çš„å³éµé¸å–®
    boardEl.oncontextmenu = function(e) { e.preventDefault(); return false; };
    
    btnUndo.disabled = true;
}

// ==================== èªè¨€ ====================
function toggleLangMenu() { langMenu.classList.toggle('show'); }
function setLang(lang) {
    currentLang = lang;
    updateLanguage();
    langMenu.classList.remove('show');
}

function updateLanguage() {
    const t = TRANSLATIONS[currentLang];
    document.querySelector('h1').innerText = t.title;
    document.querySelector('[data-key="undo"]').innerText = t.undo;
    document.querySelector('[data-key="clear"]').innerText = t.clear;
    document.querySelector('[data-key="solve"]').innerText = isCalculating ? t.calculating : t.solve;
    document.querySelector('[data-key="confirm"]').innerText = t.confirm; 
    
    if (btnNext.disabled && currentStepIdx >= solutionSteps.length && solutionSteps.length > 0) {
        btnNext.innerText = t.finish;
    } else {
        btnNext.innerText = t.next;
    }

    document.querySelector('[data-key="handLabel"]').innerText = t.handLabel;
    document.querySelector('[data-key="empty"]').innerText = t.empty;
    document.querySelector('[data-key="selectTitle"]').innerText = t.selectTitle;
    document.querySelector('[data-key="selectHint"]').innerText = t.selectHint;
    document.querySelector('[data-key="helpTitle"]').innerText = t.helpTitle;
    document.querySelector('[data-key="contact"]').innerText = t.contact;
    
    const titles = document.querySelectorAll('.category-title');
    titles.forEach((el, idx) => { el.innerText = t.categories[idx]; });
    helpText.innerHTML = t.helpBody;
}

// ==================== æ¸²æŸ“ ====================
function renderBoard() {
    boardEl.innerHTML = '';
    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            if (board[r][c] === 1) {
                const isNew = newlyPlacedCells.some(p => p.r === r && p.c === c);
                if (isNew) cell.classList.add('new'); 
                else cell.classList.add('filled'); 
            }
            if (clearingCells.some(p => p.r === r && p.c === c)) {
                cell.classList.add('clearing');
            }
            cell.dataset.r = r; cell.dataset.c = c;
            
            // â˜…â˜…â˜… v10.3 æ ¸å¿ƒï¼šç¶å®šäº‹ä»¶åˆ°æ ¼å­ â˜…â˜…â˜…
            cell.addEventListener('mousedown', onPointerDown);
            cell.addEventListener('mouseenter', onPointerEnter);
            cell.addEventListener('touchstart', onPointerDown, {passive: false});
            
            boardEl.appendChild(cell);
        }
    }
    // boardå®¹å™¨ä¹Ÿè¦ç¶å®š move ä»¥æ”¯æŒæ»‘å‹•
    boardEl.addEventListener('touchmove', onTouchMove, {passive: false});
}

function renderLibraryMenu() {
    libContentEl.innerHTML = '';
    CATEGORIES.forEach(cat => {
        const title = document.createElement('div');
        title.className = 'category-title';
        libContentEl.appendChild(title);
        const grid = document.createElement('div');
        grid.className = 'lib-grid';
        cat.list.forEach(name => {
            if (!SHAPES[name]) return;
            const div = document.createElement('div');
            div.className = 'lib-piece';
            div.dataset.name = name; 
            setupLibraryItemEvents(div, name);
            const badge = document.createElement('div');
            badge.className = 'count-badge';
            div.appendChild(badge);
            
            const preview = createShapeElement(SHAPES[name], 6);
            div.appendChild(preview);
            
            grid.appendChild(div);
        });
        libContentEl.appendChild(grid);
    });
}

function renderHand() {
    handEl.innerHTML = '';
    if (hand.length === 0) {
        handEl.innerHTML = `<span style="color: #777;" data-key="empty">${TRANSLATIONS[currentLang].empty}</span>`;
        return;
    }
    hand.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'hand-piece';
        div.onclick = () => { removeFromHand(idx); }; 
        
        const preview = createShapeElement(item.shape, 8);
        div.appendChild(preview);
        
        const removeBtn = document.createElement('div');
        removeBtn.className = 'remove-btn';
        removeBtn.innerText = 'x';
        div.appendChild(removeBtn);
        handEl.appendChild(div);
    });
}

function createShapeElement(shape, cellSize) {
    const rows = shape.length;
    const cols = shape[0].length;
    const wrapper = document.createElement('div');
    wrapper.className = 'mini-grid-wrapper';
    const grid = document.createElement('div');
    grid.className = 'mini-grid';
    grid.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`;
    grid.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const cell = document.createElement('div');
            if (shape[r][c] === 1) cell.className = 'mini-cell';
            grid.appendChild(cell);
        }
    }
    wrapper.appendChild(grid);
    return wrapper;
}

// ==================== äº’å‹• ====================
function setupLibraryItemEvents(element, name) {
    let pressTimer; let isLongPress = false;
    
    const startPress = (e) => {
        if (e.type === 'touchstart' && e.touches.length > 1) return;
        isLongPress = false;
        
        pressTimer = setTimeout(() => { 
            isLongPress = true; 
            handleLongPress(e, element, name); 
        }, 500);
    };

    const cancelPress = () => { 
        if (pressTimer) clearTimeout(pressTimer); 
    };

    const endPress = (e) => {
        if (pressTimer) clearTimeout(pressTimer);
        
        if (!isLongPress) {
            if (e.type === 'touchend') e.preventDefault();
            handleTap(name); 
        }
    };

    element.addEventListener('mousedown', startPress);
    element.addEventListener('mouseleave', cancelPress);
    element.addEventListener('mouseup', endPress);
    element.addEventListener('touchstart', startPress, {passive: false});
    element.addEventListener('touchmove', cancelPress, {passive: true}); 
    element.addEventListener('touchend', endPress);
}

function openLibrary() { updateLibraryUI(); document.getElementById('libModal').classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); hideQtyPopup(); }
function openHelp() { document.getElementById('helpModal').classList.add('show'); }

// â˜…â˜…â˜… å–®é»é‚è¼¯ â˜…â˜…â˜…
function handleTap(name) {
    const count = hand.filter(h => h.name === name).length;

    if (count > 0) {
        // æœ‰ -> æ¸›1
        for (let i = hand.length - 1; i >= 0; i--) {
            if (hand[i].name === name) {
                removeFromHand(i); 
                break; 
            }
        }
    } else {
        // ç„¡ -> åŠ 1
        if (hand.length < 3) {
            addToHand(name);
            updateLibraryUI();
            checkConfirmButton();
            renderHand();
            resetSolution();
        }
    }
}

// é•·æŒ‰
function handleLongPress(e, element, name) {
    currentLongPressName = name;
    const rect = element.getBoundingClientRect();
    qtyPopup.style.top = (rect.top - 50) + 'px';
    qtyPopup.style.left = (rect.left + rect.width/2 - 60) + 'px'; 
    qtyPopup.style.display = 'flex';
    qtyOverlay.style.display = 'block'; 
}

function hideQtyPopup() {
    qtyPopup.style.display = 'none';
    qtyOverlay.style.display = 'none';
    currentLongPressName = null;
}

// é¸æ“‡æ•¸é‡
function setQty(count) {
    if (!currentLongPressName) return;
    hand = hand.filter(h => h.name !== currentLongPressName);
    const spaceLeft = 3 - hand.length;
    const toAdd = Math.min(count, spaceLeft);
    for(let i=0; i<toAdd; i++) addToHand(currentLongPressName);
    
    renderHand(); 
    updateLibraryUI(); 
    checkConfirmButton(); 
    resetSolution();
    hideQtyPopup();
}

function clearSelection() {
    if(hand.length > 0) {
        hand = [];
        renderHand();
        updateLibraryUI();
        checkConfirmButton();
        resetSolution();
    }
}

function removeFromHand(idx) {
    hand.splice(idx, 1);
    renderHand(); 
    updateLibraryUI(); 
    checkConfirmButton();
    resetSolution();
}

function checkConfirmButton() {
    if (hand.length === 3) {
        btnConfirmSelection.style.display = 'inline-block';
    } else {
        btnConfirmSelection.style.display = 'none';
    }
}

function updateLibraryUI() {
    const libPieces = document.querySelectorAll('.lib-piece');
    libPieces.forEach(div => {
        const name = div.dataset.name;
        const count = hand.filter(h => h.name === name).length;
        const badge = div.querySelector('.count-badge');
        if (count > 0) {
            div.classList.add('selected'); badge.innerText = 'x' + count; badge.style.display = 'block';
        } else {
            div.classList.remove('selected'); badge.style.display = 'none';
        }
    });
    const selCount = document.getElementById('selCount');
    if(selCount) selCount.innerText = hand.length;
}

// ==================== ç›¤é¢æ§åˆ¶ (v4 Logic) ====================
function lockBoard(locked) {
    if (locked) boardWrapper.classList.add('locked');
    else boardWrapper.classList.remove('locked');
}

function saveState() {
    boardHistory.push({
        board: JSON.parse(JSON.stringify(board)),
        newlyPlaced: JSON.parse(JSON.stringify(newlyPlacedCells))
    });
    if(boardHistory.length > 20) boardHistory.shift();
    btnUndo.disabled = false;
}

function updateCell(r, c) {
    if (board[r][c] !== paintMode) {
        board[r][c] = paintMode;
        newlyPlacedCells = newlyPlacedCells.filter(p => !(p.r === r && p.c === c));
        renderBoard(); resetSolution();
    }
}

function onPointerDown(e) {
    if (solutionSteps.length > 0) return;
    
    // v4 æ ¸å¿ƒ: é˜»æ­¢é è¨­äº‹ä»¶
    if (e.type === 'touchstart') e.preventDefault();
    if (e.cancelable) e.preventDefault();

    // v4 æ ¸å¿ƒ: ç›´æ¥ä½¿ç”¨ e.target (æˆ– currentTarget)
    let target = e.currentTarget;
    if (target && target.classList.contains('cell')) {
        isDragging = true;
        const r = parseInt(target.dataset.r);
        const c = parseInt(target.dataset.c);
        saveState();
        paintMode = 1 - board[r][c];
        updateCell(r, c);
    }
}

function onPointerEnter(e) {
    if (solutionSteps.length > 0) return; 
    if (isDragging) {
        const r = parseInt(this.dataset.r);
        const c = parseInt(this.dataset.c);
        updateCell(r, c);
    }
}

// v4 æ ¸å¿ƒ: æ»‘å‹•è™•ç†
function onTouchMove(e) {
    if (solutionSteps.length > 0) return; 
    if (!isDragging) return;
    if (e.cancelable) e.preventDefault();
    
    const touch = e.touches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (target && target.classList.contains('cell')) {
        const r = parseInt(target.dataset.r);
        const c = parseInt(target.dataset.c);
        updateCell(r, c);
    }
}

function clearBoard() {
    saveState();
    board = Array(8).fill().map(() => Array(8).fill(0));
    newlyPlacedCells = []; clearingCells = [];
    hand = []; 
    renderHand();
    updateLibraryUI();
    checkConfirmButton(); 
    renderBoard(); resetSolution(); lockBoard(false);
    btnUndo.disabled = true; 
}

function undoBoard() {
    if (solutionSteps.length > 0) {
        if (currentStepIdx > 0) {
            if (boardHistory.length > 0) {
                const state = boardHistory.pop();
                board = state.board;
                newlyPlacedCells = state.newlyPlaced || [];
                currentStepIdx--;
                previewStep(); 
            }
        } else {
            resetSolution();
        }
        return;
    }

    if (boardHistory.length > 0) {
        const state = boardHistory.pop();
        board = state.board;
        newlyPlacedCells = state.newlyPlaced || [];
        clearingCells = [];
        renderBoard();
        
        if (boardHistory.length === 0) btnUndo.disabled = true;
    }
}

function addToHand(name) {
    if (hand.length >= 3) return;
    hand.push({ name: name, shape: SHAPES[name] });
    renderHand(); resetSolution();
}

// ==================== ç®—æ³• ====================
function resetSolution() {
    solutionSteps = [];
    currentStepIdx = 0;
    statusEl.innerText = '';
    isCalculating = false;
    btnSolve.disabled = false;
    btnSolve.innerText = TRANSLATIONS[currentLang].solve;
    btnNext.disabled = true;
    btnNext.innerText = TRANSLATIONS[currentLang].next;
    btnClear.disabled = false;

    clearingCells = []; 
    renderBoard(); 
    document.querySelectorAll('.cell.preview').forEach(el => { el.classList.remove('preview'); el.innerText = ''; });
    lockBoard(false); 
}

function solve(currentBoard, pieces) {
    let bestSol = null; let maxCleared = -1;
    function* permutations(arr) {
        if (arr.length <= 1) yield arr;
        else {
            for (let i = 0; i < arr.length; i++) {
                const rest = arr.slice(0, i).concat(arr.slice(i + 1));
                for (const p of permutations(rest)) yield [arr[i], ...p];
            }
        }
    }
    function canPlace(b, piece, r, c) {
        const rows = piece.length; const cols = piece[0].length;
        if (r + rows > 8 || c + cols > 8) return false;
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                if (piece[i][j] === 1 && b[r + i][c + j] === 1) return false;
            }
        }
        return true;
    }
    function placeAndCalculate(b, piece, r, c) {
        let newB = b.map(row => [...row]);
        const rows = piece.length; const cols = piece[0].length;
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) { if (piece[i][j]) newB[r + i][c + j] = 1; }
        }
        let clearR = 0, clearC = 0;
        for(let i=0; i<8; i++) if(newB[i].every(v=>v===1)) clearR++;
        for(let j=0; j<8; j++) if(newB.every(row=>row[j]===1)) clearC++;
        
        let cleared = clearR + clearC;
        if (cleared > 0) {
            let clearRows = [], clearCols = [];
            for(let i=0; i<8; i++) if(newB[i].every(v=>v===1)) clearRows.push(i);
            for(let j=0; j<8; j++) if(newB.every(row=>row[j]===1)) clearCols.push(j);
            for(let row of clearRows) for(let j=0; j<8; j++) newB[row][j] = 0;
            for(let col of clearCols) for(let i=0; i<8; i++) newB[i][col] = 0;
        }
        return { board: newB, cleared: cleared };
    }
    function backtrack(b, remainingPieces, path, totalCleared) {
        if (remainingPieces.length === 0) {
            if (totalCleared > maxCleared) { maxCleared = totalCleared; bestSol = [...path]; }
            return;
        }
        if (bestSol && maxCleared >= 5) return; 
        const current = remainingPieces[0];
        const rest = remainingPieces.slice(1);
        const shape = current.shape;
        
        let validMoves = [];
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                if (canPlace(b, shape, r, c)) {
                    let result = placeAndCalculate(b, shape, r, c);
                    validMoves.push({r, c, result});
                }
            }
        }
        validMoves.sort((x, y) => y.result.cleared - x.result.cleared);
        for (let move of validMoves) {
            path.push({ name: current.name, r: move.r, c: move.c, cleared: move.result.cleared, shape });
            backtrack(move.result.board, rest, path, totalCleared + move.result.cleared);
            path.pop();
            if (bestSol && maxCleared >= 5) return; 
        }
    }
    const perms = permutations(pieces);
    for (const p of perms) { backtrack(currentBoard, p, [], 0); if (bestSol && maxCleared >=5) break; }
    return bestSol;
}

function runSolver() {
    if (hand.length === 0) { statusEl.innerText = TRANSLATIONS[currentLang].msg_select; return; }
    isCalculating = true;
    btnSolve.disabled = true;
    btnClear.disabled = true;
    btnSolve.innerText = TRANSLATIONS[currentLang].calculating;
    statusEl.innerText = TRANSLATIONS[currentLang].calculating;

    setTimeout(() => {
        const sol = solve(board, hand);
        if (sol) { solutionSteps = sol; currentStepIdx = 0; previewStep(); } 
        else { 
            statusEl.innerText = TRANSLATIONS[currentLang].msg_nosol;
            isCalculating = false;
            btnSolve.disabled = false;
            btnClear.disabled = false;
            btnSolve.innerText = TRANSLATIONS[currentLang].solve;
        }
    }, 50);
}

function getClearingCells(tempBoard, step) {
    let toClear = [];
    let b = tempBoard.map(row => [...row]);
    for(let i=0; i<step.shape.length; i++) {
        for(let j=0; j<step.shape[0].length; j++) {
            if (step.shape[i][j]) b[step.r + i][step.c + j] = 1;
        }
    }
    let rows = [], cols = [];
    for(let i=0; i<8; i++) if(b[i].every(v=>v===1)) rows.push(i);
    for(let j=0; j<8; j++) if(b.every(r=>r[j]===1)) cols.push(j);
    for(let r of rows) for(let c=0; c<8; c++) toClear.push({r,c});
    for(let c of cols) for(let r=0; r<8; r++) toClear.push({r,c});
    return toClear;
}

function previewStep() {
    const t = TRANSLATIONS[currentLang];
    if (currentStepIdx >= solutionSteps.length) {
        statusEl.innerText = t.msg_done;
        statusEl.style.color = "#2ECC71";
        btnNext.disabled = false;
        btnNext.innerText = t.finish; 
        clearingCells = [];
        renderBoard(); 
        document.querySelectorAll('.cell.preview').forEach(el => { el.classList.remove('preview'); el.innerText = ''; });
        return;
    }

    lockBoard(true);
    const step = solutionSteps[currentStepIdx];
    statusEl.innerText = `${t.msg_step} ${currentStepIdx + 1}: ${t.msg_clear} ${step.cleared} ${t.msg_row}`;
    statusEl.style.color = "#F1C40F";
    btnNext.disabled = false;
    btnNext.innerText = t.next;

    clearingCells = getClearingCells(board, step);
    renderBoard();

    const shape = step.shape;
    const cells = document.querySelectorAll('.cell');
    for(let i=0; i<shape.length; i++) {
        for(let j=0; j<shape[0].length; j++) {
            if (shape[i][j]) {
                const idx = (step.r + i) * 8 + (step.c + j);
                if (cells[idx]) { cells[idx].classList.add('preview'); cells[idx].innerText = currentStepIdx + 1; }
            }
        }
    }
}

function applyNextStep() {
    const t = TRANSLATIONS[currentLang];
    if (currentStepIdx >= solutionSteps.length) {
        newlyPlacedCells = []; 
        hand = []; renderHand(); updateLibraryUI(); checkConfirmButton();
        boardHistory = []; 
        btnUndo.disabled = true; 
        resetSolution(); 
        return;
    }

    const step = solutionSteps[currentStepIdx];
    saveState();

    for(let i=0; i<step.shape.length; i++) {
        for(let j=0; j<step.shape[0].length; j++) {
            if (step.shape[i][j]) {
                const r = step.r + i; const c = step.c + j;
                board[r][c] = 1; newlyPlacedCells.push({r, c});
            }
        }
    }
    
    let clearR = [], clearC = [];
    for(let i=0; i<8; i++) if(board[i].every(v=>v===1)) clearR.push(i);
    for(let j=0; j<8; j++) if(board.every(row=>row[j]===1)) clearC.push(j);
    
    if (clearR.length > 0 || clearC.length > 0) {
        for(let row of clearR) for(let j=0; j<8; j++) { 
            board[row][j] = 0; newlyPlacedCells = newlyPlacedCells.filter(p => !(p.r === row && p.c === j)); 
        }
        for(let col of clearC) for(let i=0; i<8; i++) { 
            board[i][col] = 0; newlyPlacedCells = newlyPlacedCells.filter(p => !(p.r === i && p.c === col)); 
        }
    }
    
    renderBoard();
    currentStepIdx++;
    previewStep();
}

init();
</script>
</body>
</html>
