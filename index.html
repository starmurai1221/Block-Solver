<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Blast Solver v15.0</title>
    <style>
        /* --- ğŸ¨ ç¾è¡“è¨­å®š --- */
        :root {
            --bg-color: #2C3E50;
            --board-bg: #34495E;
            --cell-empty: rgba(236, 240, 241, 0.1); 
            --header-bg: #2C3E50;
            
            /* åœ–ç‰‡è³‡æº */
            --img-filled: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjN0Y4QzhEIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1Ii8+PHBhdGggZD0iTTMwIDQwIEw0MCAzMCBMNTAgNDAgTDYwIDMwIEw3MCA0MCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjMiIGZpbGw9Im5vbmUiLz48Y2lyY2xlIGN4PSIzNSIgY3k9IjYwIiByPSI1IiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iNjUiIGN5PSI2MCIgcj0iNSIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==');
            --img-new: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzQ5OERCIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1Ii8+PHBhdGggZD0iTTIwIDMwIEwzMCAxNSBMNDAgMzAgTDYwIDMwIEw3MCAxNSBMODAgMzAiIGZpbGw9IiMyOTgwQjkiLz48Y2lyY2xlIGN4PSIzNSIgY3k9IjU1IiByPSI1IiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iNjUiIGN5PSI1NSIgcj0iNSIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik00NSA3MCBRNTAgODAgNTUgNzAiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzIiBmaWxsPSJub25lIi8+PC9zdmc+');
            --img-preview: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMkVDQzcxIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1IiBvcGFjaXR5PSIwLjgiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjY1IiByPSIxNSIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iNDUiIHI9IjgiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSI4IiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iNzAiIGN5PSI0NSIgcj0iOCIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==');
            --img-clearing: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjRjFDNDBGIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgcng9IjE1Ii8+PHBhdGggZD0iTTUwIDEwIEw2MCA0MCBMOTAgNTAgTDYwIDYwIEw1MCA5MCBMNDAgNjAgTDEwIDUwIEw0MCA0MCBaIiBmaWxsPSIjZmZmIi8+PC9zdmc+');
            
            --text-color: white;
            
            /* æ–¹å¡Šåˆ†é¡é¡è‰² */
            --color-dot: #F1C40F; --color-diag: #1ABC9C; --color-line: #3498DB;
            --color-square: #E74C3C; --color-t: #2ECC71; --color-z: #E67E22;
            --color-l-small: #FF80AB; --color-l-mid: #9B59B6; --color-l-mid-j: #E056FD; --color-l-big: #5C6BC0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0 10px 50px 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            overscroll-behavior: none; 
            user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
        }

        /* æ¨™é¡Œç½®ä¸­ + Sticky */
        .header { 
            width: 100%; max-width: 500px; height: 50px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; position: sticky; top: 0; z-index: 1000;
            background-color: var(--header-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); padding: 0 5px; margin-top: 0;
        }
        h1 { 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            margin: 0; font-size: 1.2rem; white-space: nowrap; pointer-events: none; z-index: 0;
        }
        .header-left, .header-right { display: flex; gap: 15px; z-index: 1; }
        .header-btn { background: transparent; border: none; color: white; font-size: 1.8rem; cursor: pointer; padding: 5px; line-height: 1; }

        .lang-menu {
            position: absolute; top: 50px; right: 0;
            background: #34495E; border-radius: 0 0 8px 8px;
            padding: 5px; display: none; flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 200;
            min-width: 120px; border: 1px solid #555;
        }
        .lang-menu.show { display: flex; }
        .lang-opt { padding: 12px; color: white; background: none; border: none; text-align: left; font-size: 1rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .lang-opt:last-child { border-bottom: none; }
        .lang-opt:active { background: #2C3E50; }

        .container {
            display: flex; flex-direction: column; width: 100%; max-width: 600px;
            align-items: center; gap: 12px; margin-top: 5px;
        }

        /* 1. æ£‹ç›¤å€ */
        .board-wrapper {
            width: 95vw; max-width: 500px;
            background-color: var(--board-bg); border-radius: 8px; padding: 5px;
            aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center;
            position: relative; touch-action: none;
        }
        .board-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; }
        .board-wrapper.locked .board-overlay { display: block; }
        .board-container { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); gap: 2px; width: 100%; height: 100%; touch-action: none; }

        .cell {
            background-color: var(--cell-empty); border-radius: 2px;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1rem; color: white;
            user-select: none; touch-action: none;
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        .cell.filled { background-image: var(--img-filled); }
        .cell.new { background-image: var(--img-new); }
        .cell.preview { background-image: var(--img-preview) !important; color: #000; opacity: 1 !important; } 
        .cell.clearing { background-image: var(--img-clearing); animation: pulse 0.5s infinite alternate; }
        .cell.preview.clearing { box-shadow: inset 0 0 0 3px #F1C40F, 0 0 15px #F1C40F; z-index: 5; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.6; } }

        /* 2. æ‰‹ç‰Œå€ */
        .hand-wrapper { width: 95vw; max-width: 500px; display: flex; flex-direction: column; gap: 5px; }
        .panel-label { font-size: 0.9rem; color: #BDC3C7; text-align: center; }
        .hand-area {
            background-color: var(--board-bg); height: 80px; border-radius: 8px;
            padding: 5px 10px; display: flex; gap: 10px; align-items: center; justify-content: flex-start;
            overflow-x: auto; white-space: nowrap;
        }
        .hand-piece {
            position: relative; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 4px;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .hand-piece .remove-btn {
            position: absolute; top: -5px; right: -5px; background: #E74C3C; color: white;
            border-radius: 50%; width: 18px; height: 18px; font-size: 12px;
            line-height: 18px; text-align: center; font-weight: bold;
        }

        /* 3. åŸ·è¡ŒæŒ‰éˆ• */
        .action-area { width: 95vw; max-width: 500px; display: flex; flex-direction: column; gap: 5px; }
        .btn-action { background-color: #27AE60; color: white; width: 100%; font-size: 1.3rem; padding: 15px; border-radius: 8px; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: background-color 0.3s; cursor: pointer; }
        .btn-action:active { transform: scale(0.98); }
        .btn-action.step { background-color: #F39C12; }
        .btn-action.finish { background-color: #2ECC71; }

        /* 4. æ§åˆ¶æŒ‰éˆ• */
        .controls { width: 95vw; max-width: 500px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 5px; }
        button {
            border: none; padding: 12px; border-radius: 6px;
            font-size: 1rem; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background-color: #555 !important; color: #aaa !important; cursor: not-allowed; }
        .btn-undo { background-color: #95A5A6; color: white; }
        .btn-clear { background-color: #E74C3C; color: white; }
        .btn-fill { background-color: #34495E; color: white; border: 1px solid #7F8C8D; } 

        /* å´é‚Šé¸å–® */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; display: none; opacity: 0; transition: opacity 0.3s; }
        .sidebar-overlay.show { display: block; opacity: 1; }
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100%; width: 85vw; max-width: 350px;
            background-color: var(--bg-color); z-index: 2001; 
            transform: translateX(-100%); transition: transform 0.3s ease-out;
            display: flex; flex-direction: column; padding: 15px; box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        .sidebar.show { transform: translateX(0); }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .sidebar-controls { display: flex; gap: 10px; }
        .library-content { flex: 1; overflow-y: auto; padding-bottom: 50px; -webkit-overflow-scrolling: touch; }
        .category-title { color: #BDC3C7; font-size: 0.9rem; margin: 15px 0 5px 0; border-bottom: 1px solid #555; }
        .lib-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .lib-piece { aspect-ratio: 1; background-color: rgba(255,255,255,0.05); border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; }
        .lib-piece:active { transform: scale(0.95); }
        .lib-piece .count-badge { position: absolute; top: -5px; right: -5px; background: #2ECC71; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; line-height: 20px; text-align: center; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 5; }
        .lib-piece.selected { border: 2px solid #2ECC71; background-color: rgba(46, 204, 113, 0.2); }
        .lib-piece.selected .count-badge { display: block; }
        .lib-piece canvas { max-width: 95%; max-height: 95%; }

        /* Popup */
        .qty-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3000; display: none; }
        .qty-popup { position: absolute; background: #34495E; border: 2px solid #2ECC71; border-radius: 12px; padding: 10px; display: none; gap: 15px; z-index: 3001; box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
        .qty-btn { width: 45px; height: 45px; border-radius: 50%; background: #2ECC71; color: white; border: none; font-size: 1.4rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .qty-btn:active { transform: scale(0.9); }

        .status-msg { text-align: center; margin: 5px 0; min-height: 20px; color: #F1C40F; font-weight: bold; }

        /* Help Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .modal.show { visibility: visible; opacity: 1; }
        .modal-container { position: relative; width: 100%; max-width: 500px; }
        .modal-card { background: #34495E; width: 100%; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); display: flex; flex-direction: column; max-height: 80vh; text-align: center; }
        .modal-close-outer { position: absolute; top: -40px; right: 0; background: transparent; border: none; color: white; font-size: 2rem; cursor: pointer; line-height: 1; padding: 5px; }
        .modal-header { margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; width: 100%; }
        .help-content { overflow-y: auto; color: #ddd; font-size: 0.95rem; line-height: 1.6; }
        .help-content h3 { color: #3498DB; margin-top: 15px; margin-bottom: 5px; }
        .help-content p { margin: 5px 0; }
        .help-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #555; }
        .help-footer a { color: #2ECC71; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <button class="header-btn" onclick="openSidebar()">â˜°</button>
        </div>
        <h1>Block Blast è§£é¡Œå™¨</h1>
        <div class="header-right">
            <button class="header-btn" onclick="toggleLangMenu()">ğŸŒ</button>
            <button class="header-btn" onclick="openHelp()">â”</button>
        </div>
        
        <div id="langMenu" class="lang-menu">
            <button class="lang-opt" onclick="setLang('zh')">ç¹é«”ä¸­æ–‡</button>
            <button class="lang-opt" onclick="setLang('en')">English</button>
            <button class="lang-opt" onclick="setLang('jp')">æ—¥æœ¬èª</button>
            <button class="lang-opt" onclick="setLang('kr')">í•œêµ­ì–´</button>
        </div>
    </div>

    <div class="container">
        <div id="boardWrapper" class="board-wrapper">
            <div class="board-overlay"></div>
            <div id="board" class="board-container"></div>
        </div>
        
        <div class="hand-wrapper">
            <div class="panel-label" id="handLabel" data-key="handLabel">æœ¬è¼ªæ–¹å¡Š (é»æ“Š x åˆªé™¤)</div>
            <div id="hand" class="hand-area"></div>
        </div>

        <div class="action-area">
            <button id="btnAction" class="btn-action" onclick="handleAction()" data-key="solve">âœ¨ è¨ˆç®—æœ€ä½³è§£ âœ¨</button>
            <div id="status" class="status-msg"></div>
        </div>

        <div class="controls">
            <button id="btnUndo" class="btn-undo" onclick="undoBoard()" disabled data-key="undo">â†º å¾©åŸ</button>
            <button id="btnFill" class="btn-fill" onclick="fillBoard()" data-key="fill">â¬› å…¨æ»¿</button>
            <button id="btnClear" class="btn-clear" onclick="clearBoard()" data-key="clear">ğŸ—‘ æ¸…ç©º</button>
        </div>
    </div>

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0"><span data-key="selectTitle">é¸æ“‡æ–¹å¡Š</span> <span style="font-size:0.8em">(<span id="selCount">0</span>/3)</span></h3>
            <div class="sidebar-controls">
                <button class="clear-sel-btn" onclick="clearSelection()" style="background:transparent;border:none;color:#E74C3C;font-size:1.5rem;">ğŸ—‘</button>
            </div>
        </div>
        <div style="font-size: 0.8rem; color: #BDC3C7; margin-bottom: 10px;" data-key="selectHint">é»æ“Š: +1 / -1 | é•·æŒ‰: é¸æ•¸é‡</div>
        <div id="libContent" class="library-content"></div>
    </div>

    <div id="qtyOverlay" class="qty-overlay" onclick="hideQtyPopup()"></div> 
    <div id="qtyPopup" class="qty-popup">
        <button class="qty-btn" onclick="selectQty(1)">1</button>
        <button class="qty-btn" onclick="selectQty(2)">2</button>
        <button class="qty-btn" onclick="selectQty(3)">3</button>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-container">
            <button class="modal-close-outer" onclick="closeHelp()">Ã—</button>
            <div class="modal-card">
                <div class="modal-header">
                    <h2 style="margin:0; width:100%; text-align:center;" data-key="helpTitle">ä½¿ç”¨æŒ‡å—</h2>
                </div>
                <div class="help-content" id="helpText"></div>
            </div>
        </div>
    </div>

<script>
// ==========================================
// 0. å¤šèªè¨€ (i18n)
// ==========================================
const TRANSLATIONS = {
    zh: {
        title: "Block Blast è§£é¡Œå™¨",
        undo: "â†º å¾©åŸ", prev: "â® ä¸Šä¸€æ­¥", fill: "â¬› å…¨æ»¿", clear: "ğŸ—‘ æ¸…ç©º",
        solve: "âœ¨ è¨ˆç®—æœ€ä½³è§£ âœ¨", next_step: "åŸ·è¡Œ æ­¥é©Ÿ ", finish: "âœ” å®Œæˆ",
        calculating: "è¨ˆç®—ä¸­...",
        handLabel: "æœ¬è¼ªæ–¹å¡Š (é»æ“Š x åˆªé™¤)",
        selectTitle: "é¸æ“‡æ–¹å¡Š", selectHint: "é»æ“Š: +1/-1 | é•·æŒ‰: é¸æ•¸é‡",
        helpTitle: "ä½¿ç”¨æŒ‡å—", contact: "é‚„æœ‰å•é¡Œå—ï¼Ÿå¯„ä¿¡çµ¦æˆ‘ï¼š",
        cat_dot: "é» & æ–œç·š", cat_line: "ç›´ç·š", cat_sq: "æ–¹å¡Š", cat_t: "T å‹", cat_z: "Z å‹ (æ©«/ç›´)",
        cat_l2: "å° L (3æ ¼)", cat_l3_l: "ä¸­ L (4æ ¼ - Lå‹)", cat_l3_j: "ä¸­ L (4æ ¼ - Jå‹)", cat_lbig: "å¤§ L (5æ ¼)",
        msg_select: "è«‹å…ˆé¸æ“‡æ–¹å¡Šï¼", msg_nosol: "âŒ ç„¡è§£ï¼", msg_done: "ğŸ‰ å®Œæˆï¼",
        msg_step: "æ­¥é©Ÿ", msg_clear: "æ¶ˆ", msg_row: "è¡Œ",
        helpBody: `<h3>1. è¨­å®šç›¤é¢</h3><p>æ‰‹æŒ‡åœ¨æ£‹ç›¤ä¸Šæ»‘å‹•å¯å¿«é€Ÿå¡—é»‘/æ“¦é™¤ã€‚<br>æŒ‰ã€Œå…¨æ»¿ã€å¯å¡«æ»¿æ‰€æœ‰æ ¼å­ã€‚</p><h3>2. é¸æ“‡æ–¹å¡Š</h3><p>é»å·¦ä¸Šè§’ â˜° æ‰“é–‹é¸å–®ã€‚<br><b>å–®é»ï¼š</b>åŠ å…¥/ç§»é™¤ã€‚<br><b>é•·æŒ‰ï¼š</b>è¨­å®šæ•¸é‡ã€‚</p><h3>3. è¨ˆç®—</h3><p>æŒ‰ã€Œè¨ˆç®—æœ€ä½³è§£ã€ã€‚<br>ç¶ è‰²=æ”¾ç½®ï¼Œé‡‘è‰²=æ¶ˆé™¤ã€‚</p>`
    },
    en: {
        title: "Block Blast Solver",
        undo: "â†º Undo", prev: "â® Prev", fill: "â¬› Fill", clear: "ğŸ—‘ Clear",
        solve: "âœ¨ Solve âœ¨", next_step: "Do Step ", finish: "âœ” Done",
        calculating: "Calculating...",
        handLabel: "Current Pieces (Tap x to remove)",
        selectTitle: "Select Pieces", selectHint: "Tap: +1/-1 | Hold: Qty",
        helpTitle: "User Guide", contact: "Questions? Email me:",
        cat_dot: "Dots & Diag", cat_line: "Lines", cat_sq: "Squares", cat_t: "T-Shape", cat_z: "Z-Shape",
        cat_l2: "Small L (3)", cat_l3_l: "Mid L (L)", cat_l3_j: "Mid L (J)", cat_lbig: "Big L (5)",
        msg_select: "Select pieces first!", msg_nosol: "âŒ No Solution!", msg_done: "ğŸ‰ Done!",
        msg_step: "Step", msg_clear: "Clear", msg_row: "lines",
        helpBody: `<h3>1. Setup Board</h3><p>Swipe to paint/erase blocks.<br>Tap "Fill" to fill all.</p><h3>2. Select Pieces</h3><p>Tap â˜° to open menu.<br><b>Tap:</b> Add/Remove.<br><b>Hold:</b> Set Quantity.</p><h3>3. Solve</h3><p>Tap "Solve".<br>Green=Place, Gold=Clear.</p>`
    },
    jp: { title: "ãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ã‚ºãƒ«è§£æ³•", undo: "â†º æˆ»ã‚‹", prev: "â® å‰ã¸", fill: "â¬› å…¨åŸ‹", clear: "ğŸ—‘ å‰Šé™¤", solve: "âœ¨ è¨ˆç®— âœ¨", next_step: "å®Ÿè¡Œï¼šæ‰‹é † ", finish: "âœ” å®Œäº†", calculating: "è¨ˆç®—ä¸­...", handLabel: "æ‰‹æŒã¡", selectTitle: "é¸æŠ", selectHint: "ã‚¿ãƒƒãƒ—:+/- | é•·æŠ¼ã—:æ•°é‡", helpTitle: "ä½¿ã„æ–¹", contact: "è³ªå•ï¼Ÿ", 
    cat_dot: "ç‚¹ & æ–œã‚", cat_line: "ç›´ç·š", cat_sq: "å››è§’", cat_t: "Tå‹", cat_z: "Zå‹", cat_l2: "å° L", cat_l3_l: "ä¸­ L (L)", cat_l3_j: "ä¸­ L (J)", cat_lbig: "å¤§ L",
    msg_select: "ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸æŠï¼", msg_nosol: "âŒ è§£ãªã—", msg_done: "ğŸ‰ å®Œäº†", msg_step: "æ‰‹é †", msg_clear: "æ¶ˆå»", msg_row: "è¡Œ", helpBody: `<h3>1. ç›¤é¢è¨­å®š</h3><p>ã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’æç”»ã€‚<br>ã€Œå…¨åŸ‹ã€ã§å…¨ã¦åŸ‹ã‚ã‚‹ã€‚</p><h3>2. é¸æŠ</h3><p>â˜° ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã€‚<br><b>ã‚¿ãƒƒãƒ—ï¼š</b>è¿½åŠ /å‰Šé™¤ã€‚<br><b>é•·æŠ¼ã—ï¼š</b>æ•°é‡æŒ‡å®šã€‚</p>` },
    
    kr: { title: "ë¸”ë¡ í¼ì¦ ì†”ë²„", undo: "â†º ì·¨ì†Œ", prev: "â® ì´ì „", fill: "â¬› ì±„ìš°ê¸°", clear: "ğŸ—‘ ì§€ìš°ê¸°", solve: "âœ¨ í•´ê²° âœ¨", next_step: "ì‹¤í–‰: ë‹¨ê³„ ", finish: "âœ” ì™„ë£Œ", calculating: "ê³„ì‚° ì¤‘...", handLabel: "í˜„ì¬ ë¸”ë¡", selectTitle: "ì„ íƒ", selectHint: "íƒ­: +/- | ê¸¸ê²Œ: ìˆ˜ëŸ‰", helpTitle: "ì‚¬ìš©ë²•", contact: "ë¬¸ì˜:", 
    cat_dot: "ê¸°ë³¸", cat_line: "ì§ì„ ", cat_sq: "ì‚¬ê°í˜•", cat_t: "Tì", cat_z: "Zì", cat_l2: "ì†Œ L", cat_l3_l: "ì¤‘ L (L)", cat_l3_j: "ì¤‘ L (J)", cat_lbig: "ëŒ€ L",
    msg_select: "ë¸”ë¡ ì„ íƒ!", msg_nosol: "âŒ í•´ê²° ë¶ˆê°€", msg_done: "ğŸ‰ ì™„ë£Œ", msg_step: "ë‹¨ê³„", msg_clear: "ì œê±°", msg_row: "ì¤„", helpBody: `<h3>1. ë³´ë“œ ì„¤ì •</h3><p>ë“œë˜ê·¸í•˜ì—¬ ê·¸ë¦¬ê¸°.<br>ã€Œì±„ìš°ê¸°ã€ë¡œ ì „ì²´ ì±„ì›€.</p><h3>2. ì„ íƒ</h3><p>â˜° ë©”ë‰´ ì—´ê¸°.<br><b>íƒ­:</b> ì¶”ê°€/ì‚­ì œ.<br><b>ê¸¸ê²Œ:</b> ìˆ˜ëŸ‰.</p>` }
};

let currentLang = 'zh';

// ==========================================
// 1. è³‡æ–™å®šç¾©
// ==========================================
const SHAPES = {
    '1': [[1]],
    'd2': [[1,0],[0,1]], 'd2_r': [[0,1],[1,0]],
    'd3': [[1,0,0],[0,1,0],[0,0,1]], 'd3_r': [[0,0,1],[0,1,0],[1,0,0]],
    '2h': [[1,1]], '3h': [[1,1,1]], '4h': [[1,1,1,1]], '5h': [[1,1,1,1,1]],
    '2v': [[1],[1]], '3v': [[1],[1],[1]], '4v': [[1],[1],[1],[1]], '5v': [[1],[1],[1],[1],[1]],
    '2x2': [[1,1],[1,1]], '2x3': [[1,1,1],[1,1,1]], '3x2': [[1,1],[1,1],[1,1]], '3x3': [[1,1,1],[1,1,1],[1,1,1]],
    'T_0': [[1,1,1],[0,1,0]], 'T_90': [[0,1],[1,1],[0,1]], 'T_180': [[0,1,0],[1,1,1]], 'T_270': [[1,0],[1,1],[1,0]],
    'Z_h': [[1,1,0],[0,1,1]], 'S_h': [[0,1,1],[1,1,0]], 'Z_v': [[0,1],[1,1],[1,0]], 'S_v': [[1,0],[1,1],[0,1]],
    'L2_0': [[1,0],[1,1]], 'L2_90': [[1,1],[1,0]], 'L2_180': [[1,1],[0,1]], 'L2_270': [[0,1],[1,1]],
    'L3_2_0': [[1,0],[1,0],[1,1]], 'L3_2_90': [[1,1,1],[1,0,0]], 'L3_2_180': [[1,1],[0,1],[0,1]], 'L3_2_270': [[0,0,1],[1,1,1]],
    'J3_2_0': [[0,1],[0,1],[1,1]], 'J3_2_90': [[1,0,0],[1,1,1]], 'J3_2_180': [[1,1],[1,0],[1,0]], 'J3_2_270': [[1,1,1],[0,0,1]],
    'L4_0': [[1,0,0],[1,0,0],[1,1,1]], 'L4_90': [[1,1,1],[1,0,0],[1,0,0]], 
    'L4_180': [[1,1,1],[0,0,1],[0,0,1]], 'L4_270': [[0,0,1],[0,0,1],[1,1,1]]
};

const CATEGORIES = [
    { key: 'cat_dot', list: ['1', 'd2', 'd2_r', 'd3', 'd3_r'] },
    { key: 'cat_line', list: ['2h', '3h', '4h', '5h', '2v', '3v', '4v', '5v'] },
    { key: 'cat_sq', list: ['2x2', '2x3', '3x2', '3x3'] },
    { key: 'cat_t', list: ['T_0', 'T_90', 'T_180', 'T_270'] },
    { key: 'cat_z', list: ['Z_h', 'S_h', 'Z_v', 'S_v'] },
    { key: 'cat_l2', list: ['L2_0', 'L2_90', 'L2_180', 'L2_270'] },
    { key: 'cat_l3_l', list: ['L3_2_0', 'L3_2_90', 'L3_2_180', 'L3_2_270'] },
    { key: 'cat_l3_j', list: ['J3_2_0', 'J3_2_90', 'J3_2_180', 'J3_2_270'] },
    { key: 'cat_lbig', list: ['L4_0', 'L4_90', 'L4_180', 'L4_270'] }
];

function getColor(name) {
    if (name === '1') return 'var(--color-dot)';
    if (name.startsWith('d')) return 'var(--color-diag)';
    if (name.startsWith('L2')) return 'var(--color-l-small)';
    if (name.includes('L3_2')) return 'var(--color-l-mid)';
    if (name.includes('J3_2')) return 'var(--color-l-mid-j)';
    if (name.startsWith('L4')) return 'var(--color-l-big)';
    if (name.includes('h') || (name.includes('v') && !name.includes('Z') && !name.includes('S'))) return 'var(--color-line)';
    if (name.includes('x')) return 'var(--color-square)';
    if (name.startsWith('T')) return 'var(--color-t)';
    if (name.startsWith('Z') || name.startsWith('S')) return 'var(--color-z)';
    return '#95A5A6';
}

// ==========================================
// ç‹€æ…‹
// ==========================================
let board = Array(8).fill().map(() => Array(8).fill(0));
let newlyPlacedCells = []; 
let clearingCells = [];    
let boardHistory = [];
let hand = [];
let solutionSteps = [];
let currentStepIdx = 0;
let isDragging = false;
let paintMode = 1; 
let currentLongPressName = null;
let solverState = 'idle';

const boardEl = document.getElementById('board');
const handEl = document.getElementById('hand');
const libContentEl = document.getElementById('libContent');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const statusEl = document.getElementById('status');
const btnAction = document.getElementById('btnAction');
const btnUndo = document.getElementById('btnUndo');
const btnClear = document.getElementById('btnClear');
const qtyPopup = document.getElementById('qtyPopup');
const qtyOverlay = document.getElementById('qtyOverlay');
const langMenu = document.getElementById('langMenu');

function init() {
    renderBoard();
    updateLanguage(); 
    checkDailyHelp(); 
    document.addEventListener('mouseup', () => { isDragging = false; });
    document.addEventListener('touchend', () => { isDragging = false; });
    boardEl.oncontextmenu = function(e) { e.preventDefault(); return false; };
    btnUndo.disabled = true;
}

function checkDailyHelp() {
    const lastDate = localStorage.getItem('block_blast_last_visit');
    const today = new Date().toISOString().split('T')[0]; 
    if (lastDate !== today) {
        openHelp();
        localStorage.setItem('block_blast_last_visit', today);
    }
}

function toggleLangMenu() { langMenu.classList.toggle('show'); }
function setLang(lang) {
    currentLang = lang;
    updateLanguage();
    langMenu.classList.remove('show');
    renderLibraryMenu(); 
    renderHand();
    resetSolution(); 
}

function openHelp() { document.getElementById('helpModal').classList.add('show'); }
function closeHelp() { document.getElementById('helpModal').classList.remove('show'); }

function updateLanguage() {
    const t = TRANSLATIONS[currentLang];
    document.querySelector('h1').innerText = t.title;
    
    // Undo button text
    const undoText = (solutionSteps.length > 0) ? t.prev : t.undo;
    document.getElementById('btnUndo').innerText = undoText;
    
    updateActionButtonState();

    document.querySelector('[data-key="fill"]').innerText = t.fill;
    document.querySelector('[data-key="clear"]').innerText = t.clear;
    document.querySelector('[data-key="handLabel"]').innerText = t.handLabel;
    document.querySelector('[data-key="selectTitle"]').innerText = t.selectTitle;
    document.querySelector('[data-key="selectHint"]').innerText = t.selectHint;
    document.querySelector('[data-key="helpTitle"]').innerText = t.helpTitle;
    document.getElementById('helpText').innerHTML = t.helpBody + `<div class="help-footer"><p>${t.contact}</p><a href="mailto:jerry1221yen@gmail.com">ğŸ“© jerry1221yen@gmail.com</a></div>`;
}

function handleAction() {
    if (solverState === 'idle') {
        runSolver();
    } else if (solverState === 'solved') {
        // å¦‚æœç•¶å‰æ­¥é©Ÿå·²ç¶“ >= ç¸½æ­¥é©Ÿï¼Œä»£è¡¨è¦åŸ·è¡Œã€Œå®Œæˆã€å‹•ä½œ
        if (currentStepIdx >= solutionSteps.length) {
            finalizeRound();
        } else {
            applyNextStep();
        }
    }
}

function updateActionButtonState() {
    const t = TRANSLATIONS[currentLang];
    if (solverState === 'idle') {
        btnAction.innerText = t.solve;
        btnAction.className = "btn-action"; 
    } else if (solverState === 'solved') {
        if (currentStepIdx >= solutionSteps.length) {
             btnAction.innerText = t.finish;
             btnAction.className = "btn-action finish";
        } else {
             btnAction.innerText = t.next_step + (currentStepIdx + 1) + " â–¶";
             btnAction.className = "btn-action step";
        }
    }
}

function openSidebar() { renderLibraryMenu(); updateLibraryUI(); sidebar.classList.add('show'); sidebarOverlay.classList.add('show'); }
function closeSidebar() { sidebar.classList.remove('show'); sidebarOverlay.classList.remove('show'); hideQtyPopup(); }
function fillBoard() { if (solutionSteps.length > 0) return; saveState(); board = Array(8).fill().map(() => Array(8).fill(1)); newlyPlacedCells = []; renderBoard(); resetSolution(); }

function renderBoard() {
    if (boardEl.children.length !== 64) {
        boardEl.innerHTML = '';
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.r = r; cell.dataset.c = c;
                cell.addEventListener('mousedown', onPointerDown);
                cell.addEventListener('mouseenter', onPointerEnter);
                cell.addEventListener('touchstart', onPointerDown, {passive: false});
                boardEl.appendChild(cell);
            }
        }
        boardEl.addEventListener('touchmove', onTouchMove, {passive: false});
    }
    
    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            const idx = r * 8 + c;
            const cell = boardEl.children[idx];
            cell.className = 'cell'; 
            cell.innerText = ''; 
            
            if (board[r][c] === 1) cell.classList.add('filled');
            if (newlyPlacedCells.some(p => p.r === r && p.c === c)) { cell.classList.remove('filled'); cell.classList.add('new'); }
            if (clearingCells.some(p => p.r === r && p.c === c)) { cell.classList.add('clearing'); }
        }
    }
}

function renderLibraryMenu() {
    libContentEl.innerHTML = '';
    const t = TRANSLATIONS[currentLang];
    CATEGORIES.forEach(cat => {
        const title = document.createElement('div'); title.className = 'category-title'; title.innerText = t[cat.key]; libContentEl.appendChild(title);
        const grid = document.createElement('div'); grid.className = 'lib-grid'; 
        cat.list.forEach(name => {
            if (!SHAPES[name]) return;
            const div = document.createElement('div'); div.className = 'lib-piece'; div.dataset.name = name; 
            setupLibraryItemEvents(div, name); 
            const badge = document.createElement('div'); badge.className = 'count-badge'; div.appendChild(badge);
            const canvas = drawShapeCanvas(SHAPES[name], 8, getColor(name)); div.appendChild(canvas); grid.appendChild(div);
        });
        libContentEl.appendChild(grid);
    });
}

function setupLibraryItemEvents(element, name) {
    let pressTimer; let isLongPress = false;
    const start = (e) => {
        if (e.type === 'touchstart' && e.touches.length > 1) return;
        isLongPress = false;
        pressTimer = setTimeout(() => { isLongPress = true; handleLongPress(e, element, name); }, 500);
    };
    const cancel = () => { if (pressTimer) clearTimeout(pressTimer); };
    const end = (e) => {
        if (pressTimer) clearTimeout(pressTimer);
        if (!isLongPress) { if (e.type === 'touchend') e.preventDefault(); handleTap(name); }
    };
    element.addEventListener('mousedown', start); element.addEventListener('mouseleave', cancel); element.addEventListener('mouseup', end);
    element.addEventListener('touchstart', start, {passive: false}); element.addEventListener('touchmove', cancel, {passive: true}); element.addEventListener('touchend', end);
}

function handleTap(name) {
    const count = hand.filter(h => h.name === name).length;
    if (count > 0) { for (let i = hand.length - 1; i >= 0; i--) { if (hand[i].name === name) { removeFromHand(i); break; } } } 
    else { if (hand.length < 3) { addToHand(name); } }
}

function handleLongPress(e, element, name) {
    currentLongPressName = name;
    const rect = element.getBoundingClientRect();
    qtyPopup.style.top = (rect.top - 50) + 'px'; qtyPopup.style.left = (rect.left + rect.width/2 - 60) + 'px'; 
    qtyPopup.style.display = 'flex'; qtyOverlay.style.display = 'block'; 
}

function selectQty(count) {
    setQty(count);
}

function setQty(count) {
    if (!currentLongPressName) return;
    hand = hand.filter(h => h.name !== currentLongPressName);
    const toAdd = Math.min(count, 3 - hand.length);
    for(let i=0; i<toAdd; i++) addToHand(currentLongPressName);
    setTimeout(() => { hideQtyPopup(); }, 50);
}

function hideQtyPopup() { qtyPopup.style.display = 'none'; qtyOverlay.style.display = 'none'; currentLongPressName = null; }
function clearSelection() { hand = []; renderHand(); updateLibraryUI(); resetSolution(); }
function addToHand(name) { if (hand.length >= 3) return; hand.push({ name: name, shape: SHAPES[name] }); renderHand(); updateLibraryUI(); resetSolution(); }
function removeFromHand(idx) { hand.splice(idx, 1); renderHand(); updateLibraryUI(); resetSolution(); }

function updateLibraryUI() {
    const libPieces = document.querySelectorAll('.lib-piece');
    libPieces.forEach(div => {
        const name = div.dataset.name;
        const count = hand.filter(h => h.name === name).length;
        const badge = div.querySelector('.count-badge');
        if (count > 0) { div.classList.add('selected'); badge.innerText = 'x' + count; badge.style.display = 'block'; } 
        else { div.classList.remove('selected'); badge.style.display = 'none'; }
    });
    document.getElementById('selCount').innerText = hand.length;
}

function renderHand() {
    const t = TRANSLATIONS[currentLang];
    handEl.innerHTML = '';
    if (hand.length === 0) handEl.innerHTML = `<span style="color:#777;">${t.empty || "(Empty)"}</span>`;
    hand.forEach((item, idx) => {
        const div = document.createElement('div'); div.className = 'hand-piece'; div.onclick = () => removeFromHand(idx);
        const canvas = drawShapeCanvas(item.shape, 10, getColor(item.name)); div.appendChild(canvas);
        const removeBtn = document.createElement('div'); removeBtn.className = 'remove-btn'; removeBtn.innerText = 'x'; div.appendChild(removeBtn);
        handEl.appendChild(div);
    });
}

function drawShapeCanvas(shape, cellSize, color) {
    const canvas = document.createElement('canvas');
    const rows = shape.length; const cols = shape[0].length;
    canvas.width = cols * cellSize; canvas.height = rows * cellSize;
    const ctx = canvas.getContext('2d');
    const colorMap = { 'dot': '#F1C40F', 'diag': '#1ABC9C', 'line': '#3498DB', 'square': '#E74C3C', 't': '#2ECC71', 'z': '#E67E22', 'l-small': '#FF80AB', 'l-mid': '#9B59B6', 'l-mid-j': '#E056FD', 'l-big': '#5C6BC0' };
    let hex = '#95A5A6';
    if(color.includes('dot')) hex = colorMap['dot']; else if(color.includes('diag')) hex = colorMap['diag']; else if(color.includes('l-mid-j')) hex = colorMap['l-mid-j']; else if(color.includes('l-mid')) hex = colorMap['l-mid']; else if(color.includes('l-big')) hex = colorMap['l-big']; else if(color.includes('l-small')) hex = colorMap['l-small']; else if(color.includes('line')) hex = colorMap['line']; else if(color.includes('square')) hex = colorMap['square']; else if(color.includes('t')) hex = colorMap['t']; else if(color.includes('z')) hex = colorMap['z'];
    ctx.fillStyle = hex;
    for(let r=0; r<rows; r++) for(let c=0; c<cols; c++) if(shape[r][c]) ctx.fillRect(c*cellSize, r*cellSize, cellSize-1, cellSize-1);
    return canvas;
}

function saveState() {
    boardHistory.push({
        board: JSON.parse(JSON.stringify(board)),
        newlyPlacedCells: JSON.parse(JSON.stringify(newlyPlacedCells)),
        clearingCells: [] 
    });
    if(boardHistory.length > 20) boardHistory.shift();
    btnUndo.disabled = false;
}

function updateCell(r, c) {
    if (board[r][c] !== paintMode) {
        board[r][c] = paintMode;
        newlyPlacedCells = newlyPlacedCells.filter(p => !(p.r === r && p.c === c));
        const idx = r * 8 + c;
        const cell = boardEl.children[idx];
        cell.classList.remove('new', 'filled');
        if (paintMode === 1) cell.classList.add('filled');
        resetSolution(); 
    }
}

function clearSolutionVisuals() {
    const cells = document.querySelectorAll('.cell');
    cells.forEach(c => {
        c.classList.remove('preview', 'clearing');
        c.innerText = ''; 
    });
    solutionSteps = [];
    currentStepIdx = 0;
    statusEl.innerText = '';
    clearingCells = [];
    solverState = 'idle';
    updateActionButtonState();
    const t = TRANSLATIONS[currentLang];
    document.getElementById('btnUndo').innerText = t.undo;
}

// æ ¸å¿ƒä¿®æ­£ï¼šæŒ‰ä¸‹ã€Œå®Œæˆã€æˆ–ã€Œè§£é¡Œå¾Œè§¸ç¢°ã€æ™‚è§¸ç™¼
function finalizeRound() {
    hand = [];
    renderHand();
    updateLibraryUI();
    boardHistory = [];
    btnUndo.disabled = true;
    newlyPlacedCells = []; // æ¸…é™¤è—è‰²æ¨™è¨˜
    resetSolution(); // æ¸…é™¤è§£ç­”ä¸¦è§£é–
}

function onPointerDown(e) {
    // ä¿®æ­£1ï¼šè‹¥é‚„åœ¨åŸ·è¡Œæ­¥é©Ÿä¸­ï¼Œç¦æ­¢æ“ä½œ
    if (solutionSteps.length > 0 && currentStepIdx < solutionSteps.length) return; 
    
    // ä¿®æ­£2ï¼šè‹¥åœåœ¨ã€Œå®Œæˆã€ç‹€æ…‹ï¼Œç›´æ¥é»æ“Šç›¤é¢ => è‡ªå‹•åŸ·è¡Œå®Œæˆä¸¦å…è¨±ç·¨è¼¯
    if (solutionSteps.length > 0 && currentStepIdx >= solutionSteps.length) {
        finalizeRound();
    }

    if (e.type === 'touchstart' && e.touches.length > 1) return;
    if (e.cancelable) e.preventDefault();
    let r, c;
    if (e.type === 'touchstart') {
        if (this.dataset && this.dataset.r !== undefined) { r = parseInt(this.dataset.r); c = parseInt(this.dataset.c); } 
        else {
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (target && target.classList.contains('cell')) { r = parseInt(target.dataset.r); c = parseInt(target.dataset.c); } else return;
        }
    } else { r = parseInt(this.dataset.r); c = parseInt(this.dataset.c); }
    
    isDragging = true;
    saveState();
    paintMode = 1 - board[r][c];
    updateCell(r, c);
}
function onPointerEnter(e) { if (solutionSteps.length > 0 && currentStepIdx < solutionSteps.length) return; if (isDragging) { const r = parseInt(this.dataset.r); const c = parseInt(this.dataset.c); updateCell(r, c); } }
function onTouchMove(e) { if (solutionSteps.length > 0 && currentStepIdx < solutionSteps.length) return; if (!isDragging) return; if (e.cancelable) e.preventDefault(); const touch = e.touches[0]; const target = document.elementFromPoint(touch.clientX, touch.clientY); if (target && target.classList.contains('cell')) { const r = parseInt(target.dataset.r); const c = parseInt(target.dataset.c); updateCell(r, c); } }

function clearBoard() {
    saveState();
    board = Array(8).fill().map(() => Array(8).fill(0));
    clearingCells = []; newlyPlacedCells = []; hand = [];
    renderHand(); updateLibraryUI(); 
    renderBoard(); resetSolution();
    btnUndo.disabled = true;
}

function undoBoard() {
    const t = TRANSLATIONS[currentLang];
    if (solutionSteps.length > 0) {
        if (currentStepIdx > 0) {
            if (boardHistory.length > 0) {
                const state = boardHistory.pop();
                board = state.board;
                newlyPlacedCells = state.newlyPlacedCells;
                currentStepIdx--;
                previewStep(); 
            }
        } else {
            resetSolution(); 
        }
        return;
    }
    if (boardHistory.length > 0) {
        const state = boardHistory.pop();
        board = state.board;
        newlyPlacedCells = state.newlyPlacedCells || [];
        renderBoard();
        if (boardHistory.length === 0) btnUndo.disabled = true;
    }
}

function resetSolution() {
    clearSolutionVisuals();
    btnAction.disabled = false;
    btnClear.disabled = false; 
    if (document.querySelector('.board-wrapper.locked')) document.querySelector('.board-wrapper').classList.remove('locked');
}

// ... (solve function same as v14.4) ...
function solve(currentBoard, pieces) {
    let bestSol = null; let maxCleared = -1;
    function* permutations(arr) {
        if (arr.length <= 1) yield arr;
        else {
            for (let i = 0; i < arr.length; i++) {
                const rest = arr.slice(0, i).concat(arr.slice(i + 1));
                for (const p of permutations(rest)) yield [arr[i], ...p];
            }
        }
    }
    function canPlace(b, piece, r, c) {
        const rows = piece.length; const cols = piece[0].length;
        if (r + rows > 8 || c + cols > 8) return false;
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                if (piece[i][j] === 1 && b[r + i][c + j] === 1) return false;
            }
        }
        return true;
    }
    function placeAndCalculate(b, piece, r, c) {
        let newB = b.map(row => [...row]);
        const rows = piece.length; const cols = piece[0].length;
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) { if (piece[i][j]) newB[r + i][c + j] = 1; }
        }
        let clearR = 0, clearC = 0;
        for(let i=0; i<8; i++) if(newB[i].every(v=>v===1)) clearR++;
        for(let j=0; j<8; j++) if(newB.every(row=>row[j]===1)) clearC++;
        let cleared = clearR + clearC;
        if (cleared > 0) {
            let clearRows = [], clearCols = [];
            for(let i=0; i<8; i++) if(newB[i].every(v=>v===1)) clearRows.push(i);
            for(let j=0; j<8; j++) if(newB.every(row=>row[j]===1)) clearCols.push(j);
            for(let row of clearRows) for(let j=0; j<8; j++) newB[row][j] = 0;
            for(let col of clearCols) for(let i=0; i<8; i++) newB[i][col] = 0;
        }
        return { board: newB, cleared: cleared };
    }
    function backtrack(b, remainingPieces, path, totalCleared) {
        if (remainingPieces.length === 0) {
            if (totalCleared > maxCleared) { maxCleared = totalCleared; bestSol = [...path]; }
            return;
        }
        if (bestSol && maxCleared >= 5) return; 
        const current = remainingPieces[0];
        const rest = remainingPieces.slice(1);
        const shape = current.shape;
        
        let validMoves = [];
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                if (canPlace(b, shape, r, c)) {
                    let result = placeAndCalculate(b, shape, r, c);
                    validMoves.push({r, c, result});
                }
            }
        }
        validMoves.sort((x, y) => y.result.cleared - x.result.cleared); 
        for (let move of validMoves) {
            path.push({ name: current.name, r: move.r, c: move.c, cleared: move.result.cleared, shape });
            backtrack(move.result.board, rest, path, totalCleared + move.result.cleared);
            path.pop();
            if (bestSol && maxCleared >= 5) return; 
        }
    }
    const perms = permutations(pieces);
    for (const p of perms) { backtrack(currentBoard, p, [], 0); if (bestSol && maxCleared >=5) break; }
    return bestSol;
}

function runSolver() {
    const t = TRANSLATIONS[currentLang];
    if (hand.length === 0) { statusEl.innerText = t.msg_select; return; }
    
    statusEl.innerText = t.calculating;
    btnAction.disabled = true; 
    btnClear.disabled = true;
    
    setTimeout(() => {
        const sol = solve(board, hand);
        if (sol) {
            solutionSteps = sol;
            currentStepIdx = 0;
            solverState = 'solved'; 
            updateActionButtonState();
            previewStep();
            document.getElementById('btnUndo').innerText = t.prev;
        } else {
            statusEl.innerText = t.msg_nosol;
            btnAction.disabled = false;
            btnClear.disabled = false;
        }
        btnAction.disabled = false;
    }, 50);
}

function getClearingCells(tempBoard, step) {
    let toClear = [];
    let b = tempBoard.map(row => [...row]);
    for(let i=0; i<step.shape.length; i++) {
        for(let j=0; j<step.shape[0].length; j++) {
            if (step.shape[i][j]) b[step.r + i][step.c + j] = 1;
        }
    }
    let rows = [], cols = [];
    for(let i=0; i<8; i++) if(b[i].every(v=>v===1)) rows.push(i);
    for(let j=0; j<8; j++) if(b.every(r=>r[j]===1)) cols.push(j);
    for(let r of rows) for(let c=0; c<8; c++) toClear.push({r,c});
    for(let c of cols) for(let r=0; r<8; r++) toClear.push({r,c});
    return toClear;
}

function previewStep() {
    const t = TRANSLATIONS[currentLang];
    if (currentStepIdx >= solutionSteps.length) {
        statusEl.innerText = t.msg_done; statusEl.style.color = "#2ECC71";
        
        solverState = 'solved';
        updateActionButtonState(); 
        
        // â˜… æ ¸å¿ƒä¿®æ­£ï¼šä¸åŸ·è¡Œæ¸…ç©ºï¼Œåªæ¸…é™¤è¦–è¦ºç‰¹æ•ˆ
        clearingCells = [];
        renderBoard(); 
        document.querySelectorAll('.cell.preview').forEach(el => { el.classList.remove('preview'); el.innerText = ''; });
        return;
    }

    updateActionButtonState(); 
    document.querySelector('.board-wrapper').classList.add('locked');
    const step = solutionSteps[currentStepIdx];
    statusEl.innerText = `${t.msg_step} ${currentStepIdx + 1}: ${t.msg_clear} ${step.cleared} ${t.msg_row}`;
    statusEl.style.color = "#F1C40F";

    clearingCells = getClearingCells(board, step);
    renderBoard(); 

    const cells = document.querySelectorAll('.cell');
    const shape = step.shape;
    for(let i=0; i<shape.length; i++) {
        for(let j=0; j<shape[0].length; j++) {
            if (shape[i][j]) {
                const idx = (step.r + i) * 8 + (step.c + j);
                if (cells[idx]) { cells[idx].classList.add('preview'); cells[idx].innerText = currentStepIdx + 1; }
            }
        }
    }
}

function applyNextStep() {
    // ä¿®æ­£ï¼šæŒ‰ä¸‹ã€Œå®Œæˆã€
    if (currentStepIdx >= solutionSteps.length) {
        finalizeRound();
        return;
    }

    const step = solutionSteps[currentStepIdx];
    saveState();

    for(let i=0; i<step.shape.length; i++) {
        for(let j=0; j<step.shape[0].length; j++) {
            if (step.shape[i][j]) {
                const r = step.r + i; const c = step.c + j;
                board[r][c] = 1;
                newlyPlacedCells.push({r, c});
            }
        }
    }
    
    let clearR = [], clearC = [];
    for(let i=0; i<8; i++) if(board[i].every(v=>v===1)) clearR.push(i);
    for(let j=0; j<8; j++) if(board.every(row=>row[j]===1)) clearC.push(j);
    
    if (clearR.length > 0 || clearC.length > 0) {
        for(let row of clearR) for(let j=0; j<8; j++) {
            board[row][j] = 0; 
            newlyPlacedCells = newlyPlacedCells.filter(p => !(p.r === row && p.c === j));
        }
        for(let col of clearC) for(let i=0; i<8; i++) {
            board[i][col] = 0;
            newlyPlacedCells = newlyPlacedCells.filter(p => !(p.r === i && p.c === col));
        }
    }
    
    renderBoard();
    currentStepIdx++;
    previewStep();
}

init();
</script>
</body>
</html>
